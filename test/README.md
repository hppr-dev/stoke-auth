# Testing

This directory contains integration testing files.

## Tools

The following tools are used for testing:
 * [Docker/Docker Compose](https://www.docker.com) - resource deployment
 * [k6](https://k6.io) - load/integration testing
 * [bash task master](https://btm.hppr.dev) - scripting/building (optional)
 * Go [benchmarks](https://pkg.go.dev/testing)

## Running Integration Tests

Integration tests have been written to verify the functionality of the server:

 * Supported Certificate Types
 * Supported Database Types
 * Language Client Integration
 * Race Condition Checking

To run all of the integration test cases run `task test int -a`.

## Integration Test Configurations

Tests run with `task test int` will run a test per config in the configs/ directory following these steps:
    1. Start a stoke server with the config with an accompanying dbinit file
    2. Run tests with k6
    3. Stop the stoke server

| Config dir (configs/) | k6 test file (k6/) | dbinit file (configs/dbinit/) | test description |
| --------------------- | ------------------ | ----------------------------- | ---------------- |
| cert_type          | smoke.js              | smoke_test.yaml         | Tests issuing tokens with all supported certificate types. |
| database_type      | smoke.js              | smoke_test.yaml         | Tests issuing tokens with all supported datbase types |
| data_race          | data_race.js          | data_race.yaml          | Uses the go race detector to detect data races |
| provider_type      | provider_test.js      | provider_test.yaml      | Tests user providers can issue tokens for users |
| client_integration | client_integration.js | client_integration.yaml | Tests client libraries can communicate with stoke server |

See `task help test` for flags to include test types.

Client integration tests use the examples included in the ./client/examples directory.

## Running Unit Tests

Unit tests are located in the internal package next to the code under test.
Unit tests can be run by running `go test ./...` from the root of the repository.

Coverage can be generated by running `go test ./... -cover`, though much of the auto-discovered code is generated and thus not tested directly.
Run `task test unit -cover` to report coverage results on just the tested code.
Use `--html` to generate an html file with coverage result or `--func` to report function level results.

The main go client code is not included in the main server package testing.
Language client unit tests should accompany the client code in the client/ directory.
Run `task test client` to run client unit tests.
Note that some clients may require some environment set up.


## Performance/Load Benchmarks

Tests were run with the following failure conditions:
 * If more than 1% of requests fail, the tests stop
 * If more than 1% of requests take more than 300 ms, the tests stop

The server was configured as follows
 * Log level Info
 * Pretty logging disabled
 * Log to stdout only
 * Tracing enabled
 * Local sqlite database
 * ECDSA keys
 * 1s request timeout
 * Connected to a test LDAP container instance
 * Token issued for a user with 3 groups and 30 seperate claims
 * Aggressive key/token rotation:
  * Key Duration: 5m
  * Token duration 1m

Default run environment:
 * ~5 milliseconds / token in isolation
 * Breakpoint: ~230 tokens / second
 * High Load Test:        200 tokens / second for 10m with no loss
 * Medium Load Test:      150 tokens / second for 20m with no loss
 * Max Nominal Load Test: 100 tokens / second for 2h with no loss
   
GOMAXPROCS=1:
 * ~20 milliseconds / token in isolation
 * Breakpoint: ~58 tokens / second
 * High Load Test:        50 tokens / second for 10m with no loss
 * Medium Load Test:      25 tokens / second for 20m with no loss
 * Max Nominal Load Test: 15 tokens / second for 2h with no loss

In resource constrained environments with low traffic expectations,GOMAXPROCS=1 can be used to limit the memory/cpu footprint of the server.
Otherwise it is recommended to run the server without modifying GOMAXPROCS.

