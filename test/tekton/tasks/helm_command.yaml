apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: helm-command
spec:
  description: Run a k6 test
  params:
    - name: chart_dir
      type: string
      description: Path to the chart directory
    - name: command
      type: string
      description: Main command to run
    - name: extra_args
      type: string
      description: Extra arguments to pass to helm
  workspaces:
    - name: source
  steps:
    - name: helm
      image: alpine/helm:3.17.2
      workingDir: /workspace/source/$(params.chart_dir)
      script: | 
        #!/usr/bin/env sh
        echo Running helm $(params.command) $(params.extra_args)...
        if helm $(params.command) $(params.extra_args)
        then
          echo Run success!
          exit 0
        fi
        echo Run failed.
        echo Check to make sure the service account has access to install helm charts
        echo If you are in a local environment where you do not care about security, you can run
        echo "   kubectl create clusterrolebinding admin-by-default --clusterrole=cluster-admin --serviceaccount=default:default"
        exit 1


